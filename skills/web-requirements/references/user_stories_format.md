# User Stories Format Specification

ユーザーストーリーの出力フォーマット仕様。

## ドキュメント構造

```markdown
# 要件定義書: [機能名]

> 生成日: YYYY-MM-DD
> ステータス: Draft | In Review | Approved
> モード: greenfield | brownfield

---

## 概要
## ペルソナ
## 非ゴール（スコープ外）
## 成功指標
## User Stories
  ### Epic-XXX
    #### US-XXX
      ##### Acceptance Criteria
## 決定事項ログ
## 未解決事項
## 変更履歴
```

## セクション詳細

### 概要

```markdown
## 概要

[機能の目的と価値を 1-2 文で説明]

例:
ユーザーがメールアドレスとパスワードでサービスにログインし、
パーソナライズされた機能を利用できるようにする認証機能。
```

### ペルソナ

```markdown
## ペルソナ

| ID | 名前 | 説明 | 権限レベル |
|----|------|------|-----------|
| P-001 | 一般ユーザー | サービスを利用する顧客 | member |
| P-002 | 管理者 | システム全体を管理するスタッフ | admin |
| P-003 | ゲスト | 未登録の訪問者 | guest |
```

**ID 形式**: `P-XXX`（3 桁ゼロ埋め）

### 非ゴール

```markdown
## 非ゴール（スコープ外）

- ソーシャルログイン（OAuth）は今回のスコープ外
- 二要素認証は Phase 2 で対応予定
- パスワードレス認証は将来検討
```

### 成功指標

```markdown
## 成功指標

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| ログイン成功率 | 99% 以上 | ログ分析 |
| ログイン所要時間 | 3 秒以内 | APM |
| パスワードリセット完了率 | 95% 以上 | ファネル分析 |
```

### User Stories

#### Epic

```markdown
### Epic-001: ユーザー認証

**目的**: ユーザーが安全にサービスにアクセスできるようにする
**Priority**: MVP
**Owner**: 認証チーム
```

**ID 形式**: `Epic-XXX`

#### Story

```markdown
#### US-001: ログインする

**Priority:** MVP | Next | Later
**Traceability:** Q-003, context:auth

**As a** P-001 (一般ユーザー)
**I want to** メールアドレスとパスワードでログインする
**So that** サービスの機能を利用できる
```

**ID 形式**: `US-XXX`（3 桁ゼロ埋め）

**必須フィールド**:
- Priority
- Traceability（元となった情報源）
- As a / I want / So that

#### Acceptance Criteria

```markdown
##### Acceptance Criteria

- [ ] **AC-001-1** (正常系):
  ```gherkin
  Given 登録済みのメールアドレス「user@example.com」とパスワード「SecurePass123!」
  When ログインフォームに入力してログインボタンをクリック
  Then ダッシュボード画面に遷移する
  And 画面右上にユーザー名が表示される
  ```

- [ ] **AC-001-2** (異常系 - パスワード不一致):
  ```gherkin
  Given 登録済みのメールアドレス「user@example.com」と誤ったパスワード「WrongPass」
  When ログインフォームに入力してログインボタンをクリック
  Then 「メールアドレスまたはパスワードが正しくありません」エラーが表示される
  And ログイン画面に留まる
  ```
```

**ID 形式**: `AC-XXX-Y`（XXX = US ID、Y = 連番）

**AC タイプ**:
- `(正常系)`: 主要なユースケース
- `(異常系 - 理由)`: エラーケース
- `(境界条件 - 条件)`: エッジケース
- `(代替フロー)`: 別の方法

### 決定事項ログ

```markdown
## 決定事項ログ

| ID | 日付 | 決定 | 理由 | 関連 Story |
|----|------|------|------|-----------|
| D-001 | 2024-01-15 | JWT 認証を採用 | 既存インフラとの整合性、ステートレス性 | US-001, US-002 |
| D-002 | 2024-01-15 | セッションタイムアウト 30 分 | セキュリティ要件と UX のバランス | US-002 |
```

**ID 形式**: `D-XXX`

### 未解決事項

```markdown
## 未解決事項

- [ ] [US-003] パスワードポリシーの詳細（最小文字数、記号必須等）- 担当: セキュリティチーム、期限: 2024-01-20
- [ ] [US-005] ソーシャルログインの優先度 - 担当: プロダクトオーナー、期限: 2024-01-22
```

### 変更履歴

```markdown
## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0.0 | 2024-01-15 | AI | 初版作成 |
| 1.0.1 | 2024-01-16 | AI | レビュー指摘対応（AC-001-4 追加） |
| 1.1.0 | 2024-01-18 | AI | US-003 追加 |
```

## Gherkin 形式

### 基本構文

```gherkin
Given [前提条件]
When [操作]
Then [期待結果]
And [追加の条件/結果]
```

### 良い例

```gherkin
Given 登録済みのメールアドレス「user@example.com」とパスワード「SecurePass123!」
When ログインフォームに入力してログインボタンをクリック
Then ダッシュボード画面に遷移する
And 画面右上にユーザー名「田中太郎」が表示される
```

### 悪い例

```gherkin
# NG: 曖昧
Given ユーザーがログインしている
When 適切な操作を行う
Then 正しく処理される

# NG: 複数のアクション
When ユーザー名を入力してパスワードを入力してログインボタンをクリックする

# NG: 観測不可能
Then データベースに保存される
```

## ID 採番ルール

| 種類 | 形式 | 例 |
|------|------|-----|
| ペルソナ | P-XXX | P-001, P-002 |
| Epic | Epic-XXX | Epic-001, Epic-002 |
| Story | US-XXX | US-001, US-002 |
| AC | AC-XXX-Y | AC-001-1, AC-001-2 |
| 決定事項 | D-XXX | D-001, D-002 |

- XXX は 3 桁ゼロ埋め
- 連番で採番（欠番なし）
- 削除時は ID を再利用しない

## ステータス遷移

```
Draft → In Review → Approved
  ↑         │
  └─────────┘ (差し戻し)
```

- **Draft**: 初期作成、編集中
- **In Review**: レビュー中
- **Approved**: 承認済み、実装可能

## バリデーションルール

### 必須チェック

- [ ] 概要セクションが存在する
- [ ] ペルソナが 1 件以上定義されている
- [ ] 非ゴールセクションが存在する
- [ ] 成功指標が 1 件以上定義されている
- [ ] 全ストーリーに As a / I want / So that がある
- [ ] 全ストーリーに AC が 1 件以上ある
- [ ] 全ストーリーに異常系 AC が 1 件以上ある

### フォーマットチェック

- [ ] ID が正しい形式
- [ ] ID が連番で欠番なし
- [ ] AC が Gherkin 形式
- [ ] ペルソナ参照が定義済み ID
