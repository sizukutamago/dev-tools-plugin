# 反事実推論プロンプト集

Phase 2（Reflect）の Omission 検出で使用するプロンプトテンプレート。
変更ファイルの種類に応じて関連する観点を選択し、最低3つは必ず実施する。

## 必須プロンプト（毎回実施）

### ベテランエンジニア視点

> このタスクで、シニアエンジニアなら追加で何を確認するか？
> レビュアーとして見たとき、最初に指摘するポイントは何か？

### テスト観点

> - 境界値・エッジケースを考慮したか？
> - エラーパス（例外、タイムアウト、ネットワーク障害）をテストしたか？
> - 既存テストが壊れていないか確認したか？
> - テストを書くべきだったのに書かなかった箇所はないか？

### 代替案検討

> このタスクを解決するための別の3つのアプローチを挙げ、なぜそれらを採用しなかったか述べよ。
> 採用しなかった理由が「検討しなかった」であれば、それは不作為として記録する。

---

## 条件付きプロンプト（変更内容に応じて選択）

### セキュリティ観点

**適用条件:** 認証/認可、ユーザー入力処理、API エンドポイント、データベース操作を含む変更

> - 入力バリデーション不足はないか？
> - 認証・認可のチェックを見落としていないか？
> - 機密情報のログ出力や露出リスクはないか？
> - SQLインジェクション、XSS、CSRF の対策は十分か？
> - Rate limiting の考慮は必要ないか？
> - トークンの有効期限・ローテーション戦略は適切か？

### パフォーマンス観点

**適用条件:** データベースクエリ、ループ処理、大量データ処理、API 呼び出しを含む変更

> - N+1 クエリやループ内の重い処理を見落としていないか？
> - キャッシュすべきデータを毎回取得していないか？
> - 不要なデータの取得（SELECT * 等）をしていないか？
> - 非同期処理にすべき箇所を同期で処理していないか？
> - インデックスの追加が必要ではないか？

### 保守性観点

**適用条件:** 新規ファイル作成、大規模リファクタリング、アーキテクチャ変更

> - 将来の変更に備えた拡張ポイントを設けたか？
> - マジックナンバーやハードコード値を定数化したか？
> - ドキュメント（コメント、README）の更新を忘れていないか？
> - 既存のユーティリティ関数やヘルパーを再利用できたのに新規作成していないか？
> - 命名規則は既存コードと一貫しているか？

### エラーハンドリング観点

**適用条件:** 外部 API 呼び出し、ファイル操作、データベース操作を含む変更

> - 外部サービスが利用不可の場合の処理は考慮したか？
> - タイムアウト設定は適切か？
> - リトライ戦略は必要ないか？
> - エラーメッセージはデバッグに十分な情報を含んでいるか？
> - ユーザーへのエラー表示は適切か（技術的すぎないか）？

### 互換性・統合観点

**適用条件:** パッケージ追加、API 変更、スキーマ変更

> - 既存の依存関係との互換性は確認したか？
> - 後方互換性を壊す変更はないか？
> - 他のモジュール/サービスへの影響を確認したか？
> - マイグレーション戦略は必要ないか？

### 冪等性・安全性観点

**適用条件:** スクリプト作成、設定変更、データベースマイグレーション

> - このスクリプト/設定変更を2回実行しても安全か？
> - 中断した場合のリカバリー手順はあるか？
> - ロールバック手段は用意されているか？

### アクセシビリティ観点

**適用条件:** UI コンポーネント、フロントエンド変更

> - スクリーンリーダーで操作可能か？
> - キーボードのみで操作可能か？
> - コントラスト比は十分か？
> - ARIA 属性は適切に設定されているか？

### 依存関係・既存資産の活用観点

**適用条件:** パッケージ追加、ユーティリティ関数作成

> - 新しく追加したライブラリは、既存の依存関係（package.json 等）で代用できなかったか？
> - 既存のユーティリティ関数やヘルパーを知らずに再実装していないか？
> - プロジェクト内に同じ目的の実装が既に存在しないか？

### プロジェクト規約遵守観点

**適用条件:** 全てのセッション

> - CLAUDE.md に記載されたプロジェクト固有の規約を遵守したか？
> - 命名規則、ディレクトリ構造のパターンは既存コードと一致しているか？
> - コミットメッセージやブランチ命名の規約に従ったか？

### コミュニケーション観点

**適用条件:** 全てのセッション（ただし Problem に misunderstanding がある場合は特に重視）

> - ユーザーの暗黙の期待を確認したか？
> - 前提条件やトレードオフをユーザーに伝えたか？
> - 代替案を提示して判断を仰いだか？
> - ユーザーが明示しなかったが暗黙に期待していたことは？

---

## 使用方法

1. Phase 1 の `changed_files` と `tool_timeline` から変更内容のカテゴリを判定
2. 必須プロンプト（3つ）を必ず実施
3. 変更カテゴリに応じて条件付きプロンプトを選択（最大3つ追加）
4. 各プロンプトに対する回答を分析し、Omission として記録
5. 「検討済みで意図的にスキップ」と「検討せず見落とし」を区別

## 判定ガイドライン

| 回答パターン | 分類 | 記録 |
|-------------|------|------|
| 「〜は検討したが、〜の理由でスキップした」 | 意図的スキップ | 記録不要 |
| 「〜は検討しなかった」 | 不作為 | Omission として記録 |
| 「〜は必要だがユーザー確認が必要」 | 保留 | Try として記録 |
| 「〜は確かに見落としていた」 | 見落とし | Omission（risk_level 付き）として記録 |
